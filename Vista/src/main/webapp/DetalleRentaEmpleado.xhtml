<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:p="http://primefaces.org/ui"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xml:lang="es" lang="es">

<f:metadata>
    <f:viewParam name="idRenta" value="#{empleadoRentaUI.idRentaSeleccionada}" />
    <f:viewAction action="#{empleadoRentaUI.cargarRentaSeleccionada}" />
    <f:event type="preRenderView" listener="#{loginUI.preventBackAfterLogout}" />
</f:metadata>

<h:head>
    <title>Detalle de Tarea ##{empleadoRentaUI.rentaSeleccionada.id}</title>
    <meta http-equiv="content-type" content="application/xhtml+xml; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style type="text/css">
        @font-face {
            font-family: "Minerva Modern";
            src: url("resources/MinervaModern Bold.ttf") format("truetype");
            font-weight: bold;
            font-style: normal;
        }

        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            background: #E8DCC8;
            font-family: 'Minerva Modern', serif;
        }

        #toastSimple {
            display: none;
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #F9F1E7;
            color: #1a1a1a;
            padding: 20px 25px;
            border-left: 6px solid #3D4435;
            z-index: 9999;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            font-family: 'Minerva Modern', serif;
            font-size: 1.1rem;
            min-width: 250px;
        }

        .topbar {
            background-color: #3D4435;
            color: #C2C8CC;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
        }

        .topbar-left, .topbar-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .topbar-center {
            text-align: center;
            flex-grow: 1;
            font-style: italic;
            font-size: 22px;
        }

        .topbar a {
            text-decoration: none;
            color: #C2C8CC;
            font-size: 16px;
            margin: 0 5px;
            font-style: italic;
        }

        .topbar a:hover {
            text-decoration: underline;
        }

        .topbar img {
            width: 20px;
            height: 20px;
        }

        .main-container {
            padding: 20px 40px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .header-title {
            font-size: 2em;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .info-cards-container {
            display: flex;
            justify-content: space-between;
            gap: 30px;
            margin-bottom: 30px;
        }

        .info-card {
            background-color: white;
            padding: 25px;
            flex: 1;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-radius: 2px;
            font-size: 1.2em;
        }

        .info-row {
            margin-bottom: 15px;
            display: flex;
            align-items: baseline;
        }

        .info-label {
            font-weight: bold;
            margin-right: 10px;
            min-width: 100px;
        }

        .info-value {
            color: #333;
        }

        .articulos-section-title {
            text-align: center;
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #000;
        }

        .articulos-card{
            background-color: #3D4435;
            padding: 15px;
        }

        .custom-datatable .ui-datatable-tablewrapper table {
            border-collapse: separate !important;
            border-spacing: 0 20px !important;
            background-color: transparent !important;
        }

        .custom-datatable thead th {
            background-color: #3D4435 !important;
            color: white !important;
            text-align: center !important;
            font-weight: bold !important;
            font-family: "FreightTextCmp Pro Semibold" !important;
            border: none !important;
            padding: 10px !important;
        }

        .custom-datatable tbody tr {
            background-color: transparent !important;
            border: none !important;
        }

        .custom-datatable tbody td {
            background-color: #D9D9D9 !important;
            color: #000000 !important;
            border: none !important;
            padding: 5px 10px !important;
            text-align: center !important;
            font-family: "FreightTextCmp Pro Semibold" !important;
        }

        .custom-datatable .ui-widget-content {
            border: none !important;
            background: transparent !important;
        }

        .custom-datatable .ui-datatable-data tr.ui-datatable-even,
        .custom-datatable .ui-datatable-data tr.ui-datatable-odd {
            background: transparent !important;
        }

        .total-section {
            font-size: 1.5em;
            font-weight: bold;
            margin-top: 20px;
            color: #000;
        }

        .ui-button.btn {
            background-color: black !important;
            color: white !important;
            border: none !important;
            border-radius: 0 !important;
            padding: 10px 20px !important;
            font-family: 'Minerva Modern', serif;
        }

        .ui-confirm-dialog.ui-widget-content,
        .ui-confirm-dialog .ui-dialog-titlebar {
            background-color: #3D4435 !important;
            border-color: #3D4435 !important;
        }

        .ui-confirm-dialog .ui-dialog-content,
        .ui-confirm-dialog .ui-dialog-buttonpane {
            background-color: #3D4435 !important;
        }

        .ui-confirm-dialog .ui-dialog-title,
        .ui-confirm-dialog .ui-confirm-dialog-message,
        .ui-confirm-dialog .ui-icon {
            color: white !important;
        }

        .ui-confirm-dialog .ui-confirmdialog-yes,
        .ui-confirm-dialog .ui-confirmdialog-no.ui-button-flat {
            background-color: black !important;
            color: white !important;
        }

        .ui-confirm-dialog .ui-dialog-titlebar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px !important;
        }

        .estado-actual {
            font-size: 1.8em;
            font-weight: bold;
            color: #3D4435;
            font-family: 'Minerva Modern', serif;
            text-align: center;
            padding: 10px 0;
        }

        .dialog-comentarios .ui-dialog-titlebar {
            background-color: #3D4435 !important;
            border: none !important;
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
            position: relative !important;
        }

        .dialog-comentarios .ui-dialog-title {
            color: white !important;
            float: none !important;
        }

        .dialog-comentarios .ui-dialog-titlebar-close {
            position: absolute !important;
            right: 15px !important;
            top: 50% !important;
            transform: translateY(-50%) !important;
            margin: 0 !important;
            float: none !important;
        }

        .dialog-comentarios .ui-dialog-content {
            background-color: #3D4435 !important;
            padding: 30px !important;
        }

        .contenedor-comentarios {
            display: flex;
            gap: 20px;
            justify-content: space-between;
            width: 100%;
        }

        .columna-comentario {
            display: flex;
            flex-direction: column;
            width: 48%;
        }

        .caja-comentario {
            background-color: #D9D9D9;
            color: black;
            padding: 20px;
            width: 100%;
            min-height: 150px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            box-sizing: border-box;
        }

        .titulo-caja {
            font-family: "FreightTextCmp Pro Semibold";
            font-weight: bold;
            font-size: 1.2em;
            margin-bottom: 10px;
            display: block;
            text-transform: capitalize;
            color: white;
            text-align: left;
        }

        .texto-caja {
            font-family: 'Minerva Modern', serif;
            font-size: 1em;
            line-height: 1.4;
        }

        .dialog-input-custom .ui-dialog-content {
            padding: 0 !important;
            background-color: #3D4435 !important;
            border: none !important;
        }

        .dialog-input-custom.ui-dialog {
            border: none !important;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5) !important;
        }

        .custom-dialog-header {
            background-color: #3D4435;
            color: white;
            padding: 25px 30px 10px 30px;
            font-family: "FreightTextCmp Pro Semibold";
            font-size: 1.4em;
            font-weight: bold;
        }

        .custom-dialog-body {
            background-color: #3D4435;
            padding: 10px 30px 30px 30px;
        }

        .custom-textarea {
            width: 100%;
            background-color: #D9D9D9 !important;
            color: black !important;
            border: none !important;
            border-radius: 0 !important;
            padding: 15px !important;
            font-family: 'Minerva Modern', serif !important;
            box-sizing: border-box !important;
            box-shadow: none !important;
            font-size: 1rem;
        }

        .dialog-btn-container {
            margin-top: 25px;
            display: flex;
            gap: 15px;
        }

        .btn-black {
            background-color: black !important;
            color: white !important;
            border: none !important;
            border-radius: 0 !important;
            font-weight: normal !important;
            font-family: 'Minerva Modern', serif !important;
            padding: 8px 25px !important;
            text-transform: capitalize;
            box-shadow: none !important;
        }

        .mensaje-finalizado {
            text-align: center;
            color: #666;
            font-style: italic;
            margin-top: 10px;
            font-size: 1.1em;
        }
    </style>
</h:head>
<h:body>
    <div id="toastSimple">
        <span id="toastSimpleMessage"></span>
    </div>

    <script>
        function mostrarToastSimple(msg) {
            var t = document.getElementById('toastSimple');
            var msgSpan = document.getElementById('toastSimpleMessage');

            msgSpan.innerHTML = msg;

            t.style.display = 'block';

            setTimeout(function(){
                t.style.display = 'none';
            }, 3000);
        }
    </script>

    <div class="topbar">
        <div class="topbar-left">
            <span style="font-size:14px;">Módulo Operativo</span>
        </div>
        <div class="topbar-center">
            <a href="RentasEmpleado.xhtml">EVENTOS CAMPESTRE</a>
        </div>
        <div class="topbar-right">
            <span>Empleado</span>
            <img src="resources/administrador.png" alt="user" class="topbar-icon" />
        </div>
    </div>

    <div class="main-container">
        <h:form id="formDetalle">
            <p:growl id="growl" showDetail="true" life="5000" />

            <div class="page-header">
                <div class="header-title">
                    <h:commandLink action="RentasEmpleado.xhtml" title="Regresar">
                        <h:graphicImage value="resources/retornar.png" alt="Regresar" width="40" height="40" style="cursor: pointer;" />
                    </h:commandLink>
                    <h:outputText value="Tarea ID##{empleadoRentaUI.rentaSeleccionada.id}" style="margin-left: 10px;"/>
                </div>

                <div style="display: flex; gap: 10px; align-items: center;">
                    <!-- Botón Ver Detalles -->
                    <p:commandButton value="Ver detalles"
                                     icon="pi pi-truck"
                                     actionListener="#{empleadoRentaUI.cargarComentariosRenta}"
                                     update=":dlgDetallesComentarios"
                                     oncomplete="PF('dlgDetallesComentarios').show()"
                                     styleClass="btn"
                                     style="background-color: black !important; color: white !important; border:none;">
                    </p:commandButton>

                    <!-- Botón Avanzar Estado -->
                    <h:panelGroup rendered="#{not empty empleadoRentaUI.siguienteEstado}">
                        <p:commandButton value="Avanzar a: #{empleadoRentaUI.siguienteEstado}"
                                         styleClass="btn"
                                         process="@this"
                                         update="@form"
                                         oncomplete="if (!args.validationFailed) { mostrarToastSimple('Estado actualizado correctamente.'); }">
                            <p:ajax listener="#{empleadoRentaUI.verificarSiRequiereComentario}"
                                    event="click" />
                            <p:confirm header="Confirmar Acción"
                                       message="¿Confirmas cambiar el estado a '#{empleadoRentaUI.siguienteEstado}'? #{empleadoRentaUI.rentaSeleccionada.idEmpleado == null ? '(Se te asignará esta tarea)' : ''}"
                                       icon="pi pi-exclamation-triangle" />
                        </p:commandButton>
                    </h:panelGroup>
                </div>
            </div>

            <!-- Estado Actual en el centro -->
            <div class="estado-actual">
                Estado: #{empleadoRentaUI.rentaSeleccionada.estado}
            </div>

            <div class="info-cards-container">
                <div class="info-card">
                    <div class="info-row">
                        <span class="info-label">Nombre:</span>
                        <span class="info-value">#{empleadoRentaUI.rentaSeleccionada.idCliente.nombre}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Teléfono:</span>
                        <span class="info-value">#{empleadoRentaUI.rentaSeleccionada.idCliente.telefono}</span>
                    </div>
                    <h:panelGroup class="info-row" layout="block" rendered="#{empleadoRentaUI.rentaSeleccionada.estado eq 'En reparto' and empleadoRentaUI.rentaSeleccionada.idEmpleado != null}">
                        <span class="info-label">Pendiente a entregar por:</span>
                        <span class="info-value">#{empleadoRentaUI.rentaSeleccionada.idEmpleado.nombre}</span>
                    </h:panelGroup>

                    <h:panelGroup class="info-row" layout="block" rendered="#{empleadoRentaUI.rentaSeleccionada.entregado != null}">
                        <span class="info-label">Entregado por:</span>
                        <span class="info-value" style="vertical-align: bottom">#{empleadoRentaUI.rentaSeleccionada.entregado}</span>
                    </h:panelGroup>
                </div>

                <div class="info-card">
                    <div class="info-row">
                        <span class="info-label">Dirección:</span>
                        <span class="info-value">#{empleadoRentaUI.rentaSeleccionada.idCliente.direccion}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Fecha:</span>
                        <span class="info-value">#{empleadoRentaUI.rentaSeleccionada.fecha}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Hora:</span>
                        <span class="info-value">
                            <h:outputText value="#{empleadoRentaUI.rentaSeleccionada.hora}">
                                <f:convertDateTime pattern="HH:mm" type="localTime"/>
                            </h:outputText>
                        </span>
                    </div>
                    <h:panelGroup class="info-row" layout="block" rendered="#{empleadoRentaUI.rentaSeleccionada.estado eq 'En recoleccion' and empleadoRentaUI.rentaSeleccionada.idEmpleado != null}">
                        <span class="info-label">Pendiente a recoger por:</span>
                        <span class="info-value" style="vertical-align: bottom">#{empleadoRentaUI.rentaSeleccionada.idEmpleado.nombre}</span>
                    </h:panelGroup>

                    <h:panelGroup class="info-row" layout="block" rendered="#{empleadoRentaUI.rentaSeleccionada.recogido != null}">
                        <span class="info-label">Recogido por:</span>
                        <span class="info-value" style="vertical-align: bottom">#{empleadoRentaUI.rentaSeleccionada.recogido}</span>
                    </h:panelGroup>
                </div>
            </div>

            <div class="articulos-section-title">Artículos solicitados</div>

            <p:dataTable var="detalle"
                         value="#{empleadoRentaUI.rentaSeleccionada.detallesRenta}"
                         styleClass="custom-datatable"
                         emptyMessage="No hay artículos en esta renta."
                         style="border-spacing: 0 10px; border-collapse: separate;">

                <p:column headerText="ID">
                    <h:outputText value="#{detalle.idarticulo.id}" />
                </p:column>
                <p:column headerText="Nombre">
                    <h:outputText value="#{detalle.idarticulo.nombre}" />
                </p:column>
                <p:column headerText="Cantidad">
                    <h:outputText value="#{detalle.cantidad}" />
                </p:column>
                <p:column headerText="Precio">
                    <h:outputText value="#{detalle.idarticulo.precio}">
                        <f:convertNumber type="currency" currencySymbol="$" />
                    </h:outputText>
                </p:column>
                <p:column headerText="Tipo">
                    <h:outputText value="#{detalle.idarticulo.categoria}" />
                </p:column>
                <p:column headerText="Imagen">
                    <h:graphicImage value="#{articuloUI.getImagenBase64(detalle.idarticulo)}" width="40" height="40" style="object-fit: cover;"/>
                </p:column>
            </p:dataTable>

            <div class="total-section">
                Total: <h:outputText value="#{empleadoRentaUI.rentaSeleccionada.total}">
                <f:convertNumber type="currency" currencySymbol="$" maxFractionDigits="2"/>
            </h:outputText>
            </div>

            <!-- Mensaje cuando la tarea está finalizada -->
            <h:panelGroup rendered="#{empty empleadoRentaUI.siguienteEstado}">
                <div class="mensaje-finalizado">
                    Tarea finalizada o en espera de acción del administrador.
                </div>
            </h:panelGroup>

            <p:confirmDialog global="true" showEffect="fade" hideEffect="fade" responsive="true" width="350">
                <p:commandButton value="Sí" type="button" styleClass="ui-confirmdialog-yes" />
                <p:commandButton value="No" type="button" styleClass="ui-confirmdialog-no ui-button-flat"/>
            </p:confirmDialog>
        </h:form>
    </div>

    <!-- Diálogo para Ver Comentarios -->
    <p:dialog id="dlgDetallesComentarios"
              header="Detalles Entrega / Recolección"
              widgetVar="dlgDetallesComentarios"
              modal="true"
              width="700"
              resizable="false"
              styleClass="dialog-comentarios"
              appendTo="@(body)">

        <div class="contenedor-comentarios">
            <div class="columna-comentario">
                <h:outputText value="Entrega" styleClass="titulo-caja" />
                <div class="caja-comentario">
                    <div class="texto-caja">
                        <h:outputText value="#{empleadoRentaUI.comentarioEntrega}" />
                    </div>
                </div>
            </div>

            <div class="columna-comentario">
                <h:outputText value="Recolección" styleClass="titulo-caja" />
                <div class="caja-comentario">
                    <div class="texto-caja">
                        <h:outputText value="#{empleadoRentaUI.comentarioRecoleccion}" />
                    </div>
                </div>
            </div>
        </div>
    </p:dialog>

    <!-- Diálogo para Agregar Comentarios -->
    <p:dialog id="dlgComentarioEstado"
              widgetVar="dlgComentarioEstado"
              modal="true"
              width="600"
              resizable="false"
              closable="false"
              showHeader="false"
              styleClass="dialog-input-custom"
              appendTo="@(body)">
        <div class="custom-dialog-header">
            <h:outputText value="#{empleadoRentaUI.tituloDialogoComentario}" />
        </div>
        <h:form id="formComentario">
            <div class="custom-dialog-body">

                <p:inputTextarea value="#{empleadoRentaUI.nuevoComentarioTexto}"
                                 rows="6"
                                 styleClass="custom-textarea"
                                 placeholder="Escribe los detalles aquí..." />

                <div class="dialog-btn-container">
                    <p:commandButton value="Agregar"
                                     actionListener="#{empleadoRentaUI.confirmarCambioConComentario}"
                                     update=":formDetalle"
                                     oncomplete="if (!args.validationFailed) { PF('dlgComentarioEstado').hide(); mostrarToastSimple('Estado actualizado correctamente.'); }"
                                     styleClass="btn-black" />

                    <p:commandButton value="Sin detalles"
                                     actionListener="#{empleadoRentaUI.confirmarCambioConComentario}"
                                     update=":formDetalle"
                                     oncomplete="if (!args.validationFailed) { PF('dlgComentarioEstado').hide(); mostrarToastSimple('Estado actualizado correctamente.'); }"
                                     styleClass="btn-black" />
                </div>
            </div>
        </h:form>
    </p:dialog>
</h:body>
</html>